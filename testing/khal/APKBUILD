# Contributor: Galen Abell <galen@galenabell.com>
# Maintainer: Galen Abell <galen@galenabell.com>
pkgname=khal
_pyname=$pkgname
pkgver=0.10.3
pkgrel=0
pkgdesc="CLI calendar application build around CalDAV"
url="https://lostpackets.de/khal"
arch="noarch"
license="MIT"
options="net"
depends="
	python3
	py3-atomicwrites
	py3-click
	py3-click-log
	py3-configobj
	py3-dateutil
	py3-icalendar
	py3-tz
	py3-tzlocal
	py3-urwid
	py3-xdg
	"
makedepends="py3-setuptools py3-setuptools_scm py3-sphinx py3-sphinxcontrib-newsfeed"
checkdepends="py3-pytest py3-freezegun vdirsyncer"
subpackages="$pkgname-doc"
source="https://files.pythonhosted.org/packages/source/${_pyname%${_pyname#?}}/$_pyname/$_pyname-$pkgver.tar.gz
	tests-account-for-changed-error-message.patch
	"

build() {
	python3 setup.py build
	make -C doc man PYTHONPATH="$PWD"
}

check() {
	# skip locale tests
	# many tests are flaky: https://github.com/pimutils/khal/issues/860
	# test_import_from_stdin doesn't work in docker: https://github.com/pimutils/khal/issues/683
	local skip_tests="
		not test_vertical_month_unicode \
		and not test_vertical_month_unicode_weekdeays \
		and not test_vertical_month_unicode_weekdeays_gr \
		and not test_vertical_month_abbr_fr \
		and not test_multi_uid_vdir \
		and not test_event_different_timezones \
		and not test_birthdays \
		and not test_birthdays_no_year \
		and not test_birthdays_29feb \
		and not test_import_from_stdin"
	pytest -v -k "$skip_tests"
}

package() {
	python3 setup.py install --prefix=/usr --root="$pkgdir"
	install -Dm644 doc/build/man/$pkgname.1 "$pkgdir"/usr/share/man/man1/$pkgname.1
}

sha512sums="
bc695b1f44e6d121a04431f971150799355e39f0893eec06371cf51e6eefa10c9d2f2c7ebcf15f4189cd4a8ad29806fb44e1ceeb6b8e43a0f11db6076006c222  khal-0.10.3.tar.gz
7e8d269cae4f9906dccda30e9887c0cb39710381b258f453dc9a840f4af7f2590dff8e2de5d37b1e635f085a8dd163d6f4d463fc43f3e6629f040469f266f100  tests-account-for-changed-error-message.patch
"
