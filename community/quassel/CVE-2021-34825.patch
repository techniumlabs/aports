From 104d01d2c619f6926bcaccea860da90b19449ad5 Mon Sep 17 00:00:00 2001
From: phuzion <398094+phuzion@users.noreply.github.com>
Date: Wed, 16 Jun 2021 13:28:38 -0400
Subject: [PATCH 1/2] core: Require TLS cert to be loaded if --require-ssl is
 used If the user specifies --require-ssl, but the core cannot load a SSL/TLS
 certificate for any reason, the core will throw an exception and quit. This
 fixes a minor security vulnerability where previously, the core would simply
 fall back to plaintext mode and not offer encrypted connections at all.

---
 src/core/sslserver.cpp | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/src/core/sslserver.cpp b/src/core/sslserver.cpp
index 9c3c7edc15..c93f4861ba 100644
--- a/src/core/sslserver.cpp
+++ b/src/core/sslserver.cpp
@@ -49,6 +49,12 @@ SslServer::SslServer(QObject* parent)
 
     // Initialize the certificates for first-time usage
     if (!loadCerts()) {
+        // If the core is unable to load a certificate, and "--require-ssl" is specified,
+        // do not proceed, throw an exception and quit. This prevents the core from falling
+        // back to a plaintext-only core when they should be expecting SSL/TLS only.
+        if (Quassel::isOptionSet("require-ssl")) {
+            throw ExitException{EXIT_FAILURE, tr("--require-ssl is set, but no SSL certificate is available. Exiting.")};
+        }
         if (!sslWarningShown) {
             qWarning() << "SslServer: Unable to set certificate file\n"
                        << "          Quassel Core will still work, but cannot provide SSL for client connections.\n"

From 1fc1282f0859daa4fa2cd42a7b4d3ab785765563 Mon Sep 17 00:00:00 2001
From: Chris <398094+phuzion@users.noreply.github.com>
Date: Thu, 17 Jun 2021 21:34:57 -0400
Subject: [PATCH 2/2] Add link to certificate FAQ in --require-ssl error

Include a link to the FAQ page explaining how to set up SSL support on the quassel-irc.org website.

Co-authored-by: Shane Synan <digitalcircuit36939@gmail.com>
---
 src/core/sslserver.cpp | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/core/sslserver.cpp b/src/core/sslserver.cpp
index c93f4861ba..1c1f05cddc 100644
--- a/src/core/sslserver.cpp
+++ b/src/core/sslserver.cpp
@@ -53,7 +53,8 @@ SslServer::SslServer(QObject* parent)
         // do not proceed, throw an exception and quit. This prevents the core from falling
         // back to a plaintext-only core when they should be expecting SSL/TLS only.
         if (Quassel::isOptionSet("require-ssl")) {
-            throw ExitException{EXIT_FAILURE, tr("--require-ssl is set, but no SSL certificate is available. Exiting.")};
+            throw ExitException{EXIT_FAILURE, tr("--require-ssl is set, but no SSL certificate is available. Exiting.\n"
+                                                 "Please see https://quassel-irc.org/faq/cert to learn how to enable SSL support.")};
         }
         if (!sslWarningShown) {
             qWarning() << "SslServer: Unable to set certificate file\n"
